{% extends "base.html" %}
<title>{% block title %}Add Results{% endblock title %}Ftech</title>
{% block content %}
<div class="page-wrapper">
<div class="content container-fluid">
    <div class="page-header">
    <div class="row align-items-center">
        <div class="col">
        <h3 class="page-title">Add Results</h3>
        <ul class="breadcrumb">
            <li class="breadcrumb-item"><a href="fees.html">Results</a></li>
            <li class="breadcrumb-item active">Add Results</li>
        </ul>
        </div>
    </div>
    </div>
    {% for message in messages %}
    {% if 'success' in message.tags %}
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        Swal.fire({
          icon: "success",
          title: "Success",
          text: "{{ message|escapejs }} ",
          confirmButtonText: "OK",
        });
      });
    </script>
    {% endif %}
    {% endfor %}
    <div class="row">
    <div class="col-sm-12">
        <div class="card">
        <div class="card-body">
            <form method="post">
                {% csrf_token %}

                <div class="row">
                    <div class="col-sm-5">
                        <label>Course</label>
                        <select id="CourseInput" class="form-select">
                            {% for result in results %}
                                <option value="{{ result.result_id }}">{{result.course}}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-sm-5">
                        <label>Marks</label>
                        <input type="number" id="MarkInput" class="form-control">
                    </div>

                    <div class="col-sm-2 mt-4">
                        <button type="button" class="btn btn-primary" onclick="addResult()">Add</button>
                    </div>
                </div>

                <table class="table mt-3" id="notesTable">
                    <thead>
                        <tr>
                            <th>Course</th>
                            <th>Marks</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <script>
                    let updates = [];

                    function addResult() {
                        const select = document.getElementById("CourseInput");
                        const marks = document.getElementById("MarkInput").value;

                        if (!marks) {
                            alert("Enter marks");
                            return;
                        }

                        const resultId = select.value;
                        const courseName = select.options[select.selectedIndex].text;

                        updates.push({ resultId, courseName, marks });

                        // remove from dropdown
                        select.remove(select.selectedIndex);
                        document.getElementById("MarkInput").value = "";

                        renderTable();
                    }

                    function renderTable() {
                        const tbody = document.querySelector("#notesTable tbody");
                        tbody.innerHTML = "";

                        updates.forEach((item, index) => {
                            tbody.innerHTML += `
                            <tr>
                                <td>${item.courseName}</td>
                                <td>${item.marks}</td>
                                <td>
                                    <button type="button" class="btn btn-danger btn-sm" onclick="removeRow(${index})">Ã—</button>
                                </td>

                                <input type="hidden" name="result_ids[]" value="${item.resultId}">
                                <input type="hidden" name="marks[]" value="${item.marks}">
                            </tr>
                            `;
                        });
                    }

                    function removeRow(index) {
                        const removed = updates.splice(index, 1)[0];

                        const select = document.getElementById("CourseInput");
                        select.add(new Option(removed.courseName, removed.resultId));

                        renderTable();
                    }
                </script>
                <button type="submit" class="btn btn-success">Save Updates</button>
            </form>
        </div>
        </div>
    </div>
    </div>
</div>
</div>
{% endblock %}